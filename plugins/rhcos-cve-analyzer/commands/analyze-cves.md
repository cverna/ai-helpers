---
name: analyze-cves
description: Analyze and categorize RHCOS CVEs for verification readiness
argument-hint: "[closed|open]"
allowed-tools: ["Bash", "Read", "TodoWrite"]
---

# Analyze RHCOS CVEs

Analyze and categorize Red Hat Container OS (RHCOS) CVEs to determine which ones are ready for verification testing.

## Usage

- `/analyze-cves` - Analyze both closed and open CVEs
- `/analyze-cves closed` - Analyze only closed CVEs
- `/analyze-cves open` - Analyze only open CVEs

## Implementation Instructions

1. **Validate Arguments**: Check if status filter argument is provided
   - Accept: "closed", "open", or no argument (both)
   - Reject invalid arguments with clear error message

2. **Execute CVE Processing**:
   - For closed CVEs: `podman run --rm --env-file .env quay.io/cverna/coreos-agent-tools:latest process_rhcos_cves.py --status closed`
   - For open CVEs: `podman run --rm --env-file .env quay.io/cverna/coreos-agent-tools:latest process_rhcos_cves.py --status open`
   - For both: `podman run --rm --env-file .env quay.io/cverna/coreos-agent-tools:latest process_rhcos_cves.py`

   **Note:** Do NOT use `-it` flags as they cause TTY warnings in non-interactive mode.

3. **Process Results**: Apply categorization logic to the returned CVE data:

   **For Closed CVEs:**
   - If resolution field (9th element) contains "Done-Errata" (including "Mixed" resolutions that include Done-Errata) AND package version (7th element) is NOT "N/A" → add to `verifiable_cves`
   - If package version is "N/A" → add to `non_verifiable_cves` (no package to verify)
   - If resolution does NOT contain "Done-Errata" (e.g., only "Not a Bug", "Can't Do", "Won't Fix") → add to `non_verifiable_cves`

   **For Open CVEs:**
   - If RHEL issue URL (5th element) contains "No matching RHEL issues found" → add to `attention_cves`
   - If due date (8th element) is within 14 days of today → add to `urgent_cves`
   - If due date is in the past → mark as **OVERDUE** in `urgent_cves`
   - Others don't need categorization at this stage

   **Extracting OCP Version:**
   - The OCP version is embedded in the description field (2nd element)
   - Pattern: `[openshift-X.Y]` or `[openshift-X.Y.z]`
   - Examples:
     * "CVE-2025-9714 rhcos: ... [openshift-4.17]" → OCP version is "4.17"
     * "CVE-2025-5987 rhcos: ... [openshift-4.15.z]" → OCP version is "4.15"
   - Extract the version number to use with the get_rhcos_image.py container script

4. **Registry Authentication**: Before verifying CVEs, ensure authentication to the container registries:

   **Login using oc command:**
   ```bash
   oc login --web https://api.ci.openshift.org
   ```

   This will open a browser for authentication. Once logged in, the credentials are stored and used by podman for pulling images from registry.ci.openshift.org.

   **Verify registry access:**
   ```bash
   oc registry login
   ```

   - If login fails, the `oc adm release info` and `podman run` commands will fail to pull images
   - Credentials are typically stored in `~/.docker/config.json` or podman's auth file

5. **CVE Verification**: Verify that a CVE is fixed in an OCP build.
    1. PARSE ANALYSIS RESULTS: First, parse the analysis results to extract:
       - verifiable_cves: CVEs that should be verified
       - non_verifiable_cves: CVEs with excluded resolutions (for reporting)
       - attention_cves: Open CVEs with no RHEL issues (for reporting)
       - urgent_cves: Open CVEs with due dates within 14 days (for immediate attention)
    
    2. VERIFY CVEs: For each CVE in verifiable_cves that has a Fixed in build value:
       - Extract the package name from the Fixed in build column (only the name, not the version)
       - Use the following multi-step process to verify the package in the RHCOS build:

       **Step 1: Get RHCOS image info**
       ```bash
       podman run --rm quay.io/cverna/coreos-agent-tools:latest get_rhcos_image.py --ocp-version {ocp-version}
       ```
       This returns JSON with `release_image`, `rhel_coreos`, and `resolved_version`.

       **Important:** The `rhel_coreos` value differs by OCP version:
       - OCP 4.12: `rhel-coreos-8`
       - OCP 4.13+: `rhel-coreos`

       Run this step in parallel for all unique OCP versions to improve efficiency.

       **Step 2: Get the RHCOS container image URL**
       ```bash
       oc adm release info {release_image} --image-for {rhel_coreos}
       ```
       This returns the RHCOS container image URL (e.g., `quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:...`).

       **Step 3: Query packages in the RHCOS image**
       ```bash
       podman run --quiet --rm {container_image} rpm -qa | grep {package_name}
       ```
       This returns all packages matching the package name.

       - Analyze the packages returned to find the correct package version that matches the expected version
       - When analyzing packages, look for the exact package name match (e.g., if searching for "sudo", look for "sudo-version-release.arch")
       - If multiple packages match, choose the one that most closely matches the expected package name
       - If no packages are found, mark the verification as FAIL with "Package not found in build"

       **Note on missing packages:** Some packages (e.g., `binutils`) are not included in all RHCOS images. For example, binutils is present in OCP 4.18+ but not in 4.12-4.15. When a package is not found, this may indicate the CVE is not applicable to that version rather than a verification failure. Report these separately for manual review.

       VERSION COMPARISON RULES (CRITICAL):
       - RPM package versions follow the format: name-version-release.architecture
       - Example: sudo-1.9.5p2-1.el8_6.1.x86_64
       - The version comparison must be EXACT for the entire release string
       - Compare the FULL version-release string, not just the version part
       - Examples of proper comparison:
         * Required: sudo-1.9.5p2-1.el8_6.1, Found: sudo-1.9.5p2-1.el8_6 → FAIL (missing .1)
         * Required: sudo-1.9.5p2-1.el8_6, Found: sudo-1.9.5p2-1.el8_6.1 → PASS (higher release)
         * Required: sudo-1.9.5p2-1.el8_6, Found: sudo-1.9.5p2-1.el8_6 → PASS (exact match)
         * Required: sudo-1.9.5p2-1.el8_6.1, Found: sudo-1.9.5p2-1.el8_6.1 → PASS (exact match)
       - The check passes ONLY if the found version-release is exactly equal to or higher than the required version-release
       - If the found version is missing any part of the release string, it FAILS
       - If the found version has additional release components, it PASSES only if they represent a higher version

    3. UPDATE JIRA ISSUES: For CVEs that PASS verification, update the JIRA issue:

       **a. Transition to Verified status:**
       ```bash
       jira issue move OCPBUGS-XXXXX "Verified"
       ```

       **b. Set the Fix Version** (based on OCP version):
       - For OCP 4.17 → Fix Version: "4.17.z"
       - For OCP 4.18 → Fix Version: "4.18.z"
       - Pattern: `X.Y.z` where X.Y is the major.minor OCP version
       ```bash
       jira issue edit OCPBUGS-XXXXX --fix-version "4.XX.z" --no-input
       ```

       **c. Add verification comment** (use positional argument, NOT --body flag):
       ```bash
       jira issue comment add OCPBUGS-XXXXX "CVE fix verified in RHCOS build. Package: <package-name>, Expected: <expected-version>, Found: <found-version>, OCP: <ocp-version>. Result: PASS"
       ```

       **Important jira-cli syntax notes:**
       - Comments use positional arguments: `jira issue comment add ISSUE-KEY "comment text"`
       - Do NOT use `--body` flag (it doesn't exist)
       - **Use single-line comments only** - Multi-line comments cause the jira CLI to hang indefinitely
       - Use `--no-input` with edit commands to avoid prompts
       - Run commands separately (not chained with &&) to ensure each completes

    4. REPORT SUMMARY: Provide a comprehensive summary including:
       - Number of CVEs verified
       - Number of CVEs skipped (non_verifiable_cves)
       - Number of CVEs requiring attention (attention_cves)
       - Number of urgent CVEs (due within 14 days)
       - Verification results table
         - The table should be formatted in a way which the fields are aligned properly.

    Example output format:

    ## Verification Results
   |      CVE      |    OCPBUGS    | OCP Version | RHEL Version |      Fixed in build    |       Found in Build       |  Due date  | Verification Result |                  OCPBUGS_LINK                  |
   |---------------|---------------|-------------|--------------|------------------------|----------------------------|------------|---------------------|------------------------------------------------|
   | CVE-2021-1235 | OCPBUGS-12346 |    4.18     |     9.4      | glibc-2.34-60.el9_4.19 | glibc-2.34-60.el9_4.19     | 2025-01-01 |        PASS         | https://issues.redhat.com/browse/OCPBUGS-12346 |
   | CVE-2021-1236 | OCPBUGS-12347 |    4.15     |     9.2      | sudo-1.9.5p2-1.el8_6.1 | sudo-1.9.5p2-1.el8_6       | 2025-01-01 |        FAIL         | https://issues.redhat.com/browse/OCPBUGS-12347 |
   | CVE-2021-1237 | OCPBUGS-12348 |    4.14     |     9.2      | binutils-2.35.2-37     | Not found in image         | 2025-01-01 |        FAIL         | https://issues.redhat.com/browse/OCPBUGS-12348 |
    
    ## Summary
    - CVEs Verified: X
    - CVEs Skipped (excluded resolutions): Y
    - CVEs Requiring Attention: Z
    - Urgent CVEs (due within 14 days): W
    
    ## Skipped CVEs
    [List of CVEs with excluded resolutions and reasons]
    
    ## Attention CVEs
    [List of open CVEs with no RHEL issues]

    ## Urgent CVEs
    [List of open CVEs with due dates within 14 days, including timing analysis]

    ## Failed Verifications (Require Investigation)
    [List of CVEs that failed verification, especially those where package was not found in image - these may need manual review to determine if the CVE is actually applicable]

    ## JIRA Issues Updated
    [List of issues that were successfully transitioned to Verified with Fix Versions set]

## Error Handling

- **Invalid argument**: Display usage help and available options
- **Script execution failure**: Show clear error message with troubleshooting tips
- **No CVE data returned**: Indicate no CVEs found for the specified filter
- **JSON parsing errors**: Report data processing issues

## Notes

- CVE records are 9-element arrays: `[CVE-ID, Description, OCPBUGS-URL, RHEL-Version, RHEL-Issue-URL, Status, Package-Version, Date, Resolution]`
- Status field may show summaries like "Closed (3 issues: Closed, Closed, Closed)"
- Resolution field may show summaries like "Mixed (3 issues: Fixed, Won't Fix, Duplicate)"
- Preserve original data structure for downstream processing tools

## Best Practices

- **Use TodoWrite** to track progress when processing multiple CVEs
- **Run JIRA commands separately** (transition, then fix-version, then comment) to ensure each completes successfully
- **Verify in parallel** when possible:
  - Run `get_rhcos_image.py` for all unique OCP versions in parallel
  - Run `oc adm release info` commands in parallel
  - Run `podman run ... rpm -qa` commands in parallel for different images
- **Check verification results carefully** - the found package version must match or exceed the required version exactly
- **Report both PASS and FAIL results** in the summary table so users can see which CVEs still need attention
- **Use single-line format for JIRA comments** - Multi-line comments cause the jira CLI to hang
- **Handle missing packages gracefully** - If a package isn't in the RHCOS image, report it separately as potentially not applicable

## Example Workflow

1. Run the CVE processing script to get all CVE data
2. Categorize CVEs into verifiable, non-verifiable, attention, and urgent lists
3. For each verifiable CVE:
   - Extract OCP version from description (e.g., `[openshift-4.17]` → `4.17`)
   - Extract package name from "Fixed in build" field (e.g., `libxml2-2.9.13-13.el9_4` → `libxml2`)
   - Run get_rhcos_image.py, then oc and podman commands with the OCP version and package name
   - Compare found version with required version
4. For CVEs that PASS:
   - Transition JIRA issue to "Verified"
   - Set Fix Version (e.g., "4.17.z")
   - Add verification comment with details
5. Generate summary report with all results
